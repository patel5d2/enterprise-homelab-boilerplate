# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project Architecture

This is an enterprise-grade home lab infrastructure boilerplate that provides **interactive service selection** and automated Docker Compose deployment. The system uses a Python CLI (`labctl`) to orchestrate 20+ services with config-driven generation.

**Core Components:**
- **labctl CLI** - Python CLI built with Typer/Rich for interactive configuration and deployment
- **Config-driven generation** - YAML config → Docker Compose via Python generators (not Jinja2)
- **Traefik reverse proxy** - Automatic SSL with Let's Encrypt, service discovery
- **Monitoring stack** - Prometheus + Grafana with auto-generated configs
- **Service orchestration** - 20+ services (GitLab, Vault, Pi-hole, Nextcloud, etc.) with dependency management

**Architecture Pattern:**
1. Interactive wizard (`labctl init`) generates YAML config
2. Generator scripts (`generate-infrastructure.py`) transform config → `docker-compose.yml` + `.env`
3. Services deployed with automatic SSL, monitoring, and health checks
4. Single network (`traefik`) with label-based routing

## Essential Commands

### Setup and Installation
```bash
# Install CLI and dependencies
./install.sh

# Interactive setup wizard (includes custom environment variables)
./labctl init

# Or use Makefile
make install          # Install CLI dependencies
make quickstart       # Complete setup: install + init + validate + build + deploy
```

### Infrastructure Management
```bash
# Validate configuration
./labctl validate
make validate

# Generate Docker Compose files from config
./labctl build
make build

# Deploy services with options
./labctl deploy --build --wait
./labctl deploy --services traefik,postgres
make deploy

# Check service status
./labctl status
make status

# View logs with options
./labctl logs --follow --tail 50
./labctl logs --services grafana
make logs

# Stop services (with cleanup options)
./labctl stop --volumes --images
make clean

# Manage configuration
./labctl config --show
./labctl config --key core.domain
```

### Development Commands
```bash
# Development environment setup
make dev               # Creates venv + installs dev deps
make install-dev       # Install with dev dependencies

# Code quality (using pyproject.toml tools)
make lint              # flake8 + mypy
make format            # black + isort
make test              # pytest (no tests directory found currently)

# Docker management
make docker-pull       # Pull latest images
make docker-logs       # Show compose logs
make docker-clean      # Clean Docker system

# Backup operations
make backup            # Run backup
make restore           # Restore from backup
```

## Key File Locations

**CLI Source:**
- `cli/labctl/` - Main CLI package (Typer-based)
- `cli/labctl/cli/main.py` - CLI entry point and commands
- `cli/labctl/cli/commands/` - Individual command modules (init, build, deploy, etc.)
- `cli/labctl/core/config.py` - Pydantic configuration models
- `cli/labctl/core/compose.py` - Docker Compose generation logic

**Configuration:**
- `config/config.yaml` - Main configuration (generated by wizard)
- `config/config.example.yaml` - Example configuration template
- `config/services/` - Individual service configuration templates (18+ services)
- `examples/config.yaml` - Example configuration
- `.env` - Generated environment variables (contains passwords)

**Generation Pipeline:**
- `generate-infrastructure.py` - Main generator (YAML config → Docker Compose)
- `docker-compose.yml` - Generated compose file
- `prometheus.yml` - Generated Prometheus config

**Infrastructure:**
- `compose/` - Generated Docker Compose files
- `data/` - Persistent data volumes
- `ssl/` - SSL certificates and ACME storage

**Project Management:**
- `Makefile` - Task automation and shortcuts
- `pyproject.toml` - Python package configuration
- `install.sh` - Installation script
- `labctl` - CLI wrapper script

## Development Workflows

**Service Addition Pattern:**
1. Add service config model in `cli/labctl/core/config.py`
2. Implement generator method in `generate-infrastructure.py`
3. Add service to interactive wizard
4. Update config examples and tests

**Configuration Management:**
- Uses Pydantic models for type-safe configuration
- Config validation with helpful error messages
- Environment variable injection for secrets
- Service URLs auto-generated from domain config

**Deployment Model:**
- Single `docker-compose.yml` with all enabled services
- Traefik network for service communication
- Health checks and dependency ordering with `depends_on`
- Volume management for data persistence
- Automatic password generation and storage

**Security Patterns:**
- Let's Encrypt SSL certificates via Traefik
- Generated secure passwords stored in `.env`
- Service isolation via Docker networks
- Optional staging certificates for testing

**Monitoring Integration:**
- Auto-generated Prometheus scrape configs
- Grafana dashboards and data sources
- Service health checks and status reporting
- Uptime monitoring with Uptime Kuma

**Custom Environment Variables:**
- Interactive wizard allows adding custom environment variables per service
- Variables stored in `config.yaml` under `custom_env.variables.service_name`
- Custom variables override default service environment variables
- Press Enter to skip if no custom variables needed
- Format: KEY=value (e.g., DEBUG=true)

**CLI Design:**
- Rich console UI with colors and progress bars
- Interactive wizards with validation
- Comprehensive help and error messages
- Global options for verbose/debug output
